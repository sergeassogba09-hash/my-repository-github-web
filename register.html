<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Roboto&family=Montserrat&display=swap" rel="stylesheet">
  <title>AssoTech</title>
  <link rel="stylesheet" href="register.css">
  <style>
    /* Style du petit message */
    .password-hint {
      font-size: 12px;
      color: #f44336;
      margin-top: 4px;
      display: none;
    }
  </style>
</head>
<body>
  <!-- Décors -->
  <div class="decor-top-left"></div>
  <div class="decor-bottom-right"></div>

  <div class="container">
    <!-- Section Logo + Bouton -->
    <div class="logo-section">
      <img src="ia.png" alt="Logo IA">
      <button class="toggle-btn" id="toggleBtn">Connexion</button>
    </div>

    <!-- Section Formulaire -->
    <div class="form-section">
      <!-- Formulaire Inscription -->
      <div id="signupForm">
        <h2>Créer un compte</h2>
        <form id="signupFormElement">
          <input type="text" id="nom" placeholder="Nom" required>
          <input type="email" id="email" placeholder="Email" required>
          <input type="password" id="password" placeholder="Mot de passe" required>
          <!-- ✅ Message d’avertissement -->
          <div id="passwordHint" class="password-hint">
            ⚠️ Bien retenir votre mot de passe : en cas d’oubli, il sera impossible de récupérer ou modifier votre compte.
          </div>
          <button type="submit" class="submit-btn">Créer le compte</button>
        </form>
      </div>

      <!-- Formulaire Connexion -->
      <div id="loginForm" class="hidden">
        <h2>Connexion</h2>
        <form id="loginFormElement">
          <input type="email" id="loginEmail" placeholder="Email" required>
          <input type="password" id="loginPassword" placeholder="Mot de passe" required>
          <button type="submit" class="submit-btn">Se connecter</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Toast notification -->
  <div id="toast" class="toast"></div>

  <script>
    // Bascule entre inscription et connexion
    const toggleBtn = document.getElementById('toggleBtn');
    const signupForm = document.getElementById('signupForm');
    const loginForm = document.getElementById('loginForm');

    toggleBtn.addEventListener('click', () => {
      if (signupForm.classList.contains('hidden')) {
        signupForm.classList.remove('hidden');
        loginForm.classList.add('hidden');
        toggleBtn.textContent = "Connexion";
      } else {
        signupForm.classList.add('hidden');
        loginForm.classList.remove('hidden');
        toggleBtn.textContent = "Inscription";
      }
    });

    // ✅ Affichage du message quand on clique sur le champ mot de passe
    const passwordInput = document.getElementById('password');
    const passwordHint = document.getElementById('passwordHint');

    passwordInput.addEventListener('focus', () => {
      passwordHint.style.display = "block";
    });
    passwordInput.addEventListener('blur', () => {
      passwordHint.style.display = "none";
    });
  </script>

  <!-- Script Firebase avec Firestore -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getFirestore, collection, addDoc, query, where, getDocs } 
      from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCK0a0CyZveptNj1x6JKWBO800lWBsM5Uc",
      authDomain: "inscription-8ff93.firebaseapp.com",
      projectId: "inscription-8ff93",
      storageBucket: "inscription-8ff93.firebasestorage.app",
      messagingSenderId: "318298371779",
      appId: "1:318298371779:web:1da0a0386663cf5198d476",
      measurementId: "G-3BSF2CHNB2"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const signupFormElement = document.getElementById('signupFormElement');
    const loginFormElement = document.getElementById('loginFormElement');
    const toast = document.getElementById('toast');

    // Fonction toast
    function showToast(message, type="success") {
      toast.textContent = message;
      toast.className = "toast show " + type;
      setTimeout(() => {
        toast.className = toast.className.replace("show", "");
      }, 3000);
    }

    // Vérification robustesse mot de passe
    function validatePassword(password) {
      const minLength = 8;
      const hasUpper = /[A-Z]/.test(password);
      const hasLower = /[a-z]/.test(password);
      const hasNumber = /[0-9]/.test(password);
      const hasSpecial = /[^A-Za-z0-9]/.test(password);

      return password.length >= minLength && hasUpper && hasLower && hasNumber && hasSpecial;
    }

    // Hashage SHA-256
    async function hashPassword(password) {
      const encoder = new TextEncoder();
      const data = encoder.encode(password);
      const hashBuffer = await crypto.subtle.digest("SHA-256", data);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, "0")).join("");
    }

    // Soumission formulaire inscription
    signupFormElement.addEventListener('submit', async (e) => {
      e.preventDefault();

      const nom = document.getElementById('nom').value;
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      if (!validatePassword(password)) {
        showToast("Mot de passe trop faible : min 8 caractères, majuscule, minuscule, chiffre et symbole requis.", "error");
        return;
      } 

      try {
        const q = query(collection(db, "users"), where("email", "==", email));
        const querySnapshot = await getDocs(q);

        if (!querySnapshot.empty) {
          showToast("Cet email est déjà utilisé.", "error");
          return;
        }

        const hashedPassword = await hashPassword(password);
        await addDoc(collection(db, "users"), { nom, email, password: hashedPassword });
        showToast("Utilisateur inscrit avec succès !", "success");
        signupFormElement.reset();

      } catch (err) {
        showToast("Erreur lors de l'inscription : " + err, "error");
      }
    });

    // Soumission formulaire connexion
    loginFormElement.addEventListener('submit', async (e) => {
      e.preventDefault();

      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;

      try {
        const q = query(collection(db, "users"), where("email", "==", email));
        const querySnapshot = await getDocs(q);

        if (querySnapshot.empty) {
          showToast("Email non trouvé.", "error");
          return;
        }

        let userDoc;
        querySnapshot.forEach(doc => {
          userDoc = doc.data();
        });

        const hashedPassword = await hashPassword(password);

        if (userDoc.password === hashedPassword) {
          showToast("Connexion réussie !", "success");
          loginFormElement.reset();

          localStorage.setItem("loggedInUser", JSON.stringify({
            email: userDoc.email,
            nom: userDoc.nom
          }));

          setTimeout(() => {
            window.location.href = "compte.html";
          }, 1500);
        } else {
          showToast("Mot de passe incorrect.", "error");
        }

      } catch (err) {
        showToast("Erreur lors de la connexion : " + err, "error");
      }
    });
  </script>
</body>
</html>
