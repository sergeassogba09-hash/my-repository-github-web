<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Compteur Électrique</title>
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="style.css">
  <meta name="theme-color" content="#0a84ff">
</head>
<body>
  <header>
    <h1>Compteur Électrique</h1>
  </header>

  <main>
    <div class="camera-section">
      <video id="video" autoplay playsinline style="background:#ccc;"></video>
      <img id="photoPreview" style="display:none;" alt="Photo prise">
      <canvas id="canvas" hidden></canvas>

      <div class="btn-group">
        <button type="button" id="startCamera" class="primary">Prendre photo</button>
        <button type="button" id="capturePhoto" class="secondary" disabled>Capture</button>
      </div>
    </div>

    <form id="meterForm" style="display:none;">
      <div class="form-field">
        <label for="numCompteur">Numéro du compteur</label>
        <input type="text" id="numCompteur" placeholder="Ex : CMT-203942" required>
      </div>

      <div class="form-field">
        <label for="owner">Propriétaire</label>
        <input type="text" id="owner" placeholder="Nom complet" required>
      </div>

      <div class="form-field">
        <label for="calibre">Calibre</label>
        <select id="calibre" required>
          <option value="">Choisir...</option>
          <option>5/20 A</option>
          <option>10/40 A</option>
          <option>15/60 A</option>
          <option>20/80 A</option>
        </select>
      </div>

      <div class="form-field">
        <label for="wires">Nombre de fils</label>
        <select id="wires" required>
          <option value="">Choisir...</option>
          <option>2</option>
          <option>3</option>
          <option>4</option>
        </select>
      </div>

      <div class="form-field">
        <label for="position">Position du compteur</label>
        <input type="text" id="position" placeholder="Ex : Façade, salon, poteau..." required>
      </div>

      <div class="form-field">
        <label for="notes">Remarques</label>
        <textarea id="notes" placeholder="Détails supplémentaires..."></textarea>
      </div>

      <input type="hidden" id="photoData">
      <button type="submit" class="primary">Enregistrer</button>
    </form>

    <section id="records">
      <h2>Enregistrements</h2>
      <div id="recordsList"></div>
    </section>
  </main>

  <script >
  const startBtn = document.getElementById('startCamera');
const captureBtn = document.getElementById('capturePhoto');
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const photoPreview = document.getElementById('photoPreview');
const form = document.getElementById('meterForm');
const photoDataInput = document.getElementById('photoData');
const recordsDiv = document.getElementById('recordsList');

let stream = null;
let photoTaken = false;

// Démarrer caméra
startBtn.onclick = async () => {
  try {
    stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' } });
    video.srcObject = stream;
    video.style.display = 'block';
    photoPreview.style.display = 'none';
    captureBtn.disabled = false;
    photoTaken = false;
  } catch(e){ alert("Impossible d'activer la caméra : "+e.message);}
};

// Capturer photo
captureBtn.onclick = () => {
  if(!stream) return alert("Active la caméra d'abord !");
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext('2d').drawImage(video,0,0);
  const dataUrl = canvas.toDataURL('image/png');
  photoPreview.src = dataUrl;
  photoPreview.style.display = 'block';
  video.style.display = 'none';
  photoDataInput.value = dataUrl;
  form.style.display = 'block';
  startBtn.disabled = true;
  captureBtn.disabled = true;
  if(stream) stream.getTracks().forEach(t=>t.stop());
  photoTaken = true;
};

// Enregistrer formulaire
form.onsubmit = (e) => {
  e.preventDefault();
  if(!photoTaken){ alert("Veuillez prendre une photo."); return; }

  const record = {
    id: Date.now(),
    numCompteur: document.getElementById('numCompteur').value,
    owner: document.getElementById('owner').value,
    calibre: document.getElementById('calibre').value,
    wires: document.getElementById('wires').value,
    position: document.getElementById('position').value,
    notes: document.getElementById('notes').value,
    photo: photoDataInput.value,
    date: new Date().toLocaleString()
  };

  const saved = JSON.parse(localStorage.getItem('compteurs')||'[]');
  saved.unshift(record);
  localStorage.setItem('compteurs', JSON.stringify(saved));

  form.reset();
  form.style.display='none';
  photoPreview.style.display='none';
  startBtn.disabled = false;
  captureBtn.disabled = true;
  photoTaken = false;

  renderRecords();
};

// Supprimer un enregistrement
function deleteRecord(id){
  let saved = JSON.parse(localStorage.getItem('compteurs')||'[]');
  saved = saved.filter(r => r.id !== id);
  localStorage.setItem('compteurs', JSON.stringify(saved));
  renderRecords();
}

// Afficher enregistrements
function renderRecords(){
  const saved = JSON.parse(localStorage.getItem('compteurs')||'[]');
  recordsDiv.innerHTML='';
  if(saved.length===0){ recordsDiv.innerHTML='<p>Aucun enregistrement.</p>'; return;}
  saved.forEach(r=>{
    const div = document.createElement('div');
    div.className='record';
    div.innerHTML=`
      <strong>${r.numCompteur}</strong> — ${r.owner}<br>
      <small>${r.calibre} | ${r.wires} fils | ${r.position}</small><br>
      <small>${r.date}</small>
      <img src="${r.photo}" style="margin-top:6px;"><br>
      <p>${r.notes}</p>
      <button class="deleteBtn">Supprimer</button>
    `;
    div.querySelector('.deleteBtn').onclick = ()=> deleteRecord(r.id);
    recordsDiv.appendChild(div);
  });
}

renderRecords();

if('serviceWorker' in navigator){
  navigator.serviceWorker.register('sw.js').then(()=>console.log("Service Worker enregistré"));
}

  </script>
</body>
</html>
