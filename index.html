<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Medlight Mobile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"/>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0d6efd">
  <link rel="icon" href="icon.png">
  <link rel="apple-touch-icon" href="icon.png">
  <link rel="stylesheet" href="style.css">
</head>
<body>

<div id="map"></div>

<!-- L茅gende -->
<div id="legend">
  <span class="legend-item"><span class="dot red"></span> USP1</span>
  <span class="legend-item"><span class="dot blue"></span> USP2</span>
  <span class="legend-item"><span class="dot green"></span> Infirmerie</span>
  <span class="legend-item"><span class="dot orange"></span> H么pital1</span>
  <span class="legend-item"><span class="dot purple"></span> H么pital2</span>
</div>
<button id="toggleLegend" class="btn-legend" aria-label="Afficher/masquer l茅gende">癸</button>

<!-- Barre de filtre -->
<div class="filter-bar">
  <select id="filterType">
    <option value="all">Tous</option>
    <option value="USP1">USP1</option>
    <option value="USP2">USP2</option>
    <option value="Infirmerie">Infirmerie</option>
    <option value="H么pital1">H么pital1</option>
    <option value="H么pital2">H么pital2</option>
  </select>
</div>

<!-- Boutons flottants -->
<button id="takePhoto" class="btn-float" aria-label="Ajouter centre">+</button>
<a href="save.html" class="btn-float btn-gallery" aria-label="Galerie"></a>
<button id="installPWA" class="btn-install">Installer</button>

<!-- Modals -->
<div id="formModal" class="modal">
  <div class="modal-content">
    <h3>Nouveau centre</h3>
    <form id="infoForm">
      <input type="text" id="centreName" placeholder="Nom du centre" required>
      <select id="centreType" required>
        <option value="">Type de centre</option>
        <option value="USP1">USP1</option>
        <option value="USP2">USP2</option>
        <option value="Infirmerie">Infirmerie</option>
        <option value="H么pital1">H么pital1</option>
        <option value="H么pital2">H么pital2</option>
      </select>
      <div class="modal-actions">
        <button type="button" id="cancelForm">Annuler</button>
        <button type="submit">Continuer</button>
      </div>
    </form>
  </div>
</div>

<div id="captureModal" class="modal">
  <div class="modal-content">
    <h3>Capture</h3>
    <video id="video" autoplay playsinline></video>
    <div class="modal-actions">
      <button id="closeCapture">Fermer</button>
      <button id="captureBtn">Capturer</button>
    </div>
  </div>
</div>

<div id="metaModal" class="modal">
  <div class="modal-content">
    <h3>M茅tadonn茅es</h3>
    <img id="previewImg" src="" alt="Pr茅visualisation">
    <pre id="metaData"></pre>
    <div class="modal-actions">
      <button id="okBtn">OK</button>
    </div>
  </div>
</div>

<div id="toastContainer"></div>

<!-- Scripts -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
<script>
/* --- IndexedDB Setup --- */
let db;
const request = indexedDB.open("MedlightDB", 1);
request.onupgradeneeded = e => {
  db = e.target.result;
  if (!db.objectStoreNames.contains("captures")) {
    db.createObjectStore("captures", { keyPath: "id" });
  }
};
request.onsuccess = e => { db = e.target.result; refreshMap(); };
request.onerror = e => { alert("Erreur IndexedDB : " + e.target.errorCode); };

/* Carte */
const map = L.map("map", { minZoom: 2, maxZoom: 18 }).setView([0,0], 2);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 }).addTo(map);
const clusterGroup = L.markerClusterGroup();
map.addLayer(clusterGroup);

/* Couleur par type */
function getColor(type){
  switch(type){
    case "USP1": return "#ff0000";
    case "USP2": return "#0000ff";
    case "Infirmerie": return "#00aa00";
    case "H么pital1": return "#ff8800";
    case "H么pital2": return "#800080";
    default: return "#555";
  }
}

/* Rafra卯chir carte */
function refreshMap(filter="all"){
  if (!db) return;
  const tx = db.transaction("captures", "readonly");
  const store = tx.objectStore("captures");
  const req = store.getAll();
  req.onsuccess = () => {
    const savedData = req.result || [];
    clusterGroup.clearLayers();
    savedData.forEach(d=>{
      if(d.lat!=null && d.lng!=null && (filter==="all" || d.type===filter)){
        const marker = L.circleMarker([d.lat,d.lng], {
          radius: 8,
          fillColor: getColor(d.type),
          color: "#fff",
          weight: 2,
          opacity: 1,
          fillOpacity: 0.9
        }).bindPopup(`<b>${d.name}</b><br>${d.type}<br>${d.date}<br>${d.lat}, ${d.lng}`);
        clusterGroup.addLayer(marker);
      }
    });
  };
}

/* Filtre */
document.getElementById("filterType").onchange = e => refreshMap(e.target.value);

/* Modals & capture */
const takePhotoBtn=document.getElementById("takePhoto");
const formModal=document.getElementById("formModal");
const captureModal=document.getElementById("captureModal");
const metaModal=document.getElementById("metaModal");
const video=document.getElementById("video");
const captureBtn=document.getElementById("captureBtn");
const closeCaptureBtn=document.getElementById("closeCapture");
const previewImg=document.getElementById("previewImg");
const metaData=document.getElementById("metaData");
const okBtn=document.getElementById("okBtn");
const toastContainer=document.getElementById("toastContainer");

let stream=null; let formData={}; let pendingEntry=null;

takePhotoBtn.onclick=()=>formModal.style.display="flex";
document.getElementById("cancelForm").onclick=()=>formModal.style.display="none";

document.getElementById("infoForm").onsubmit=async e=>{
  e.preventDefault();
  formData.name=document.getElementById("centreName").value.trim();
  formData.type=document.getElementById("centreType").value;
  if(!formData.name||!formData.type)return;
  formModal.style.display="none";
  captureModal.style.display="flex";
  await startCamera();
};

async function startCamera(){
  try{
    stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
    video.srcObject=stream;
  }catch{
    stream=await navigator.mediaDevices.getUserMedia({video:true});
    video.srcObject=stream;
  }
}
function stopCamera(){if(stream){stream.getTracks().forEach(t=>t.stop());stream=null;}}

closeCaptureBtn.onclick=()=>{
  captureModal.style.display="none";
  stopCamera();
};

captureBtn.onclick=()=>{
  if(video.videoWidth===0 || video.videoHeight===0){
    alert("La cam茅ra n'est pas encore pr锚te.");
    return;
  }
  const canvas=document.createElement("canvas");
  canvas.width=video.videoWidth;canvas.height=video.videoHeight;
  canvas.getContext("2d").drawImage(video,0,0);
  const imageData=canvas.toDataURL("image/png");
  const dateStr=new Date().toLocaleString();
  pendingEntry={id:Date.now().toString(),name:formData.name,type:formData.type,date:dateStr,lat:null,lng:null,image:imageData};

  captureModal.style.display="none";
  stopCamera();
  previewImg.src=imageData;
  metaData.textContent=`Nom: ${pendingEntry.name}\nType: ${pendingEntry.type}\nDate: ${pendingEntry.date}\nCoord: en cours...`;
  metaModal.style.display="flex";

  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(
      pos=>{
        pendingEntry.lat=pos.coords.latitude;
        pendingEntry.lng=pos.coords.longitude;
        metaData.textContent=`Nom: ${pendingEntry.name}\nType: ${pendingEntry.type}\nDate: ${pendingEntry.date}\nCoord: ${pendingEntry.lat}, ${pendingEntry.lng}`;
      },
      err=>{
        metaData.textContent=`Nom: ${pendingEntry.name}\nType: ${pendingEntry.type}\nDate: ${pendingEntry.date}\nCoord: indisponibles (${err.message})`;
      }
    );
  } else {
    metaData.textContent=`Nom: ${pendingEntry.name}\nType: ${pendingEntry.type}\nDate: ${pendingEntry.date}\nCoord: non support茅es`;
  }
};

/* Validation finale : enregistrement dans IndexedDB */
okBtn.onclick = () => {
  if (pendingEntry) {
    const tx = db.transaction("captures", "readwrite");
    tx.objectStore("captures").put(pendingEntry);
    tx.oncomplete = () => {
      refreshMap(document.getElementById("filterType").value);
      showToast("Photo enregistr茅e.");
      pendingEntry = null;
    };
  }
  metaModal.style.display = "none";
};

/* Toast */
function showToast(msg) {
  const t = document.createElement("div");
  t.className = "toast";
  t.textContent = msg;
  toastContainer.appendChild(t);
  setTimeout(() => t.remove(), 3000);
}

/* Toggle l茅gende */
const legend = document.getElementById("legend");
const toggleLegendBtn = document.getElementById("toggleLegend");
toggleLegendBtn.onclick = () => {
  legend.style.display = (legend.style.display==="none" ? "flex" : "none");
};

/* Service Worker */
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("./sw.js").catch(() => {});
  });
}

/* PWA install */
let deferredPrompt;
window.addEventListener("beforeinstallprompt", (e) => {
  e.preventDefault();
  deferredPrompt = e;
  const btn = document.getElementById("installPWA");
  btn.style.display = "block";
  btn.onclick = async () => {
    btn.style.display = "none";
    await deferredPrompt.prompt();
    deferredPrompt = null;
  };
});
window.addEventListener("appinstalled", () => {
  const btn = document.getElementById("installPWA");
  if (btn) btn.style.display = "none";
});
</script>
</body>
</html>
