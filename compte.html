<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AssoTech - Messagerie</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto&family=Montserrat&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="compte.css">
</head>
<body>
  <!-- Header -->
  <header>
    <div class="logo">
      <img src="ia.png" alt="Logo AssoTech">
      <h1>AssoTech</h1>
    </div>
    <div class="user-name" id="userName">Mon Compte</div>
  </header>

  <!-- Liste des profils -->
  <div class="profiles" id="profilesList"></div>

  <!-- Modal messagerie -->
  <div class="modal" id="chatModal">
    <div class="modal-header">
      <h2 id="chatWith">Discussion</h2>
      <button onclick="closeChat()">Fermer</button>
    </div>
    <div class="modal-messages" id="chatBox"></div>
    <div class="modal-input">
      <input type="text" id="chatMessage" placeholder="Écrire un message...">
      <button onclick="sendMessage()">Envoyer</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot } 
      from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCK0a0CyZveptNj1x6JKWBO800lWBsM5Uc",
      authDomain: "inscription-8ff93.firebaseapp.com",
      projectId: "inscription-8ff93",
      storageBucket: "inscription-8ff93.firebasestorage.app",
      messagingSenderId: "318298371779",
      appId: "1:318298371779:web:1da0a0386663cf5198d476",
      measurementId: "G-3BSF2CHNB2"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const loggedInUser = JSON.parse(localStorage.getItem("loggedInUser"));
    if (loggedInUser) {
      document.getElementById("userName").textContent = loggedInUser.nom;
    } else {
      window.location.href = "index.html";
    }

    // ✅ Afficher liste des membres
    const profilesList = document.getElementById("profilesList");
    import { onSnapshot as onSnap, collection as coll } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
    onSnap(coll(db, "users"), (snapshot) => {
      profilesList.innerHTML = "<h2>Liste des membres</h2>";
      snapshot.forEach((doc) => {
        const user = doc.data();
        if (user.email !== loggedInUser.email) {
          const div = document.createElement("div");
          div.className = "profile";
          div.textContent = user.nom;
          div.onclick = () => openChat(user);
          profilesList.appendChild(div);
        }
      });
    });

    // ✅ Messagerie privée
    let currentChatUser = null;
    function openChat(user) {
      currentChatUser = user;
      document.getElementById("chatWith").textContent = "Discussion avec " + user.nom;
      document.getElementById("chatModal").style.display = "flex";

      const chatBox = document.getElementById("chatBox");
      onSnap(coll(db, "messages"), (snapshot) => {
        chatBox.innerHTML = "";
        snapshot.forEach((doc) => {
          const msg = doc.data();
          if (
            (msg.from === loggedInUser.email && msg.to === user.email) ||
            (msg.from === user.email && msg.to === loggedInUser.email)
          ) {
            const div = document.createElement("div");
            div.className = "message " + (msg.from === loggedInUser.email ? "sent" : "received");
            div.textContent = msg.message;
            chatBox.appendChild(div);
          }
        });
        chatBox.scrollTop = chatBox.scrollHeight;
      });
    }

    function closeChat() {
      document.getElementById("chatModal").style.display = "none";
      currentChatUser = null;
    }

    async function sendMessage() {
      const input = document.getElementById("chatMessage");
      const message = input.value;
      if (message && currentChatUser) {
        await addDoc(collection(db, "messages"), {
          from: loggedInUser.email,
          to: currentChatUser.email,
          message,
          createdAt: new Date()
        });
        input.value = "";
      }
    }
    window.closeChat = closeChat;
    window.sendMessage = sendMessage;
  </script>
</body>
</html>
